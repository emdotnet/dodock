image: "debian:9.6"

variables:
  GIT_STRATEGY: none
  GIT_CHECKOUT: "false"

before_script:
  - apt-get update && apt-get install -y curl
  - apt-get update && apt-get install -y wget
  - apt-get update && apt-get install -y python3-minimal
  - apt-get update && apt-get install -y build-essential python-setuptools
  - apt-get update && apt-get install -y sudo
  - apt-get update && apt-get install -y systemd
  - apt-get update && apt-get install -y dbus
  - apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-suggests --no-install-recommends \
    git libffi-dev liblcms2-dev libldap2-dev libmariadbclient-dev libsasl2-dev libssl1.0-dev libtiff5-dev \
    libwebp-dev mariadb-client iputils-ping python-dev python-pip python-setuptools python-tk redis-tools rlwrap \
    software-properties-common tk8.6-dev xfonts-75dpi xfonts-base wkhtmltopdf fonts-cantarell
  - systemctl daemon-reload
  - adduser --disabled-password --gecos "" dokotest
  - usermod -aG sudo dokotest
  - export LANG=C.UTF-8
  - export LC_ALL=C.UTF-8
  - wget https://gitlab.com/dokos/docli/raw/master/playbooks/install.py
  - python3 install.py --develop --user dokotest --site test_site --run-gitlab-ci --without-bench-setup --verbose

stages:
  - Unit Tests

unittests:
  stage: Unit Tests
  script:
    - /home/dokotest/dokos-bench bench --site test_site reinstall --yes
    - /home/dokotest/dokos-bench bench --site test_site scheduler disable
    - /home/dokotest/dokos-bench bench --site test_site run-tests --coverage